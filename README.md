```markdown
# vehicle_history_blockchain/

```
vehicle_history_blockchain/
├── contracts/             ← solidity files
├── migrations/
├── build/                 ← generated by Truffle
├── client/                ← React front-end (create-react-app)
│   └── src/
│       ├── App.js
│       ├── Landing.jsx
│       ├── Landing.css
│       └── VehicleHistory.json      ← copied here after migrations
└── ganache-db/            ← persistent chain data (created on first run)
```

## Vehicle-History dApp – Local Setup Guide

**Goal:** clone the repo, spin up Ganache, deploy the smart-contract and run the React front-end… all on your own machine

### 0 Prerequisites

| Tool         | Tested Version | Why we need it             |
|--------------|----------------|----------------------------|
| Node.js      | ≥ 18 LTS (v20.19.1) | JS runtime for Truffle & React |
| Git          | any            | clone the repo               |
| Truffle      | 5.12.x         | compile / migrate the contract |
| Ganache CLI  | 7.x            | local Ethereum chain       |

### Installing the blockchain tools

```bash
# ① globally install Truffle & Ganache-CLI
npm install -g truffle ganache
ganache --version          # should print something like v7.9.x, if not npm install -g ganache

Inside react folder(client)
npm install web3
```

### 1 Clone the repo

```bash
git clone <your-repo-url>
cd vehicle_history_blockchain
```

### 2 Install JS dependencies

```bash
# root
cd vehicle_history_blockchain   # project root
npm install @openzeppelin/contracts

ganache-cli --deterministic --gasLimit 12000000 --allowUnlimitedContractSize
```

### 3 Start Ganache with a persistent database

We’ll keep the chain data under `ganache-db` so that accounts, balances and contract addresses survive restarts.

```bash
# run this inside the repo root  (NOT inside /client)
npx ganache --port 7545 --mnemonic "candy maple cake sugar pudding cream honey rich smooth crumble sweet treat" --db .\.ganache-db
```

**Why those flags?**

| flag            | explanation                                         |
|-----------------|-----------------------------------------------------|
| `--port 7545`   | matches what the React app & Truffle config expect |
| `--mnemonic …`  | hard-codes the same 10 test accounts for every teammate |
| `--db ./ganache-db` | folder where chain data blocks will be stored      |

Keep this terminal tab running.

### 4 Compile & Deploy the contract

Open a second terminal (root of the repo):

```bash
truffle compile
truffle migrate --reset      # deploys to the Ganache chain running on :7545
```

On success you’ll see a contract address (e.g. `0xE7…8Ab`).

### 5 Copy the ABI/artifact to the front-end

React only needs the generated JSON for the `VehicleHistory` contract.

```bash
# still in repo root
copy build\contracts\VehicleHistory.json client\src\VehicleHistory.json
```

### 6 Run the React front-end

```bash
cd client
npm start
```

CRA opens `http://localhost:3000` in your browser.

### 7 (Once-per-chain) grant the service / insurer roles

If you kept the default mnemonic, you can skip this step because `migrations/3_grant_demo_roles.js` automatically assigns:

| Role                  | Account       | When          |
|-----------------------|---------------|---------------|
| DMV (DEFAULT_ADMIN_ROLE) | `accounts[0]` | on deployment |
| SERVICE_ROLE          | `accounts[3]` | migration #3  |
| INSURER_ROLE          | `accounts[0]` (same as DMV for demo) | migration #3  |

If you disabled migration #3 or changed the mnemonic, do:

```bash
truffle console
truffle(development)> const vh = await VehicleHistory.deployed()
truffle(development)> await vh.grantRole(await vh.SERVICE_ROLE(), accounts[3])
truffle(development)> await vh.grantRole(await vh.INSURER_ROLE(), accounts[0])
.exit
```

### 8 Workflow after a reboot

* Start Ganache again (same command, same folder → chain resurrects).
* Compile / migrate only if you changed the Solidity.
    * Skipping this keeps the existing contract & data.
* `npm start` inside `/client`.

That’s it — no more Truffle console work unless you need manual role tweaks.

### 9 Common Errors & Fixes

| Symptom                               | Likely cause                             | Fix                                                                 |
|---------------------------------------|------------------------------------------|---------------------------------------------------------------------|
| Contract not deployed on this network pop-up | Ganache is on a different chain ID than last time | Delete `ganache-db`, restart Ganache, run `truffle migrate --reset`, copy JSON again |
| Error: Invalid or empty address       | You left an address box empty or mistyped | Paste a valid `0x…` account from Ganache                             |
| Transaction “reverted by the EVM”     | Role or VIN pre-check failed in the contract | Check the red message text – it shows the exact `require()` reason |

### Testing

#### Who is who in Ganache CLI

Open the Ganache terminal and copy the first four addresses:

| Index | Address prefix | Role we will use                     |
|-------|----------------|--------------------------------------|
| 0     | `0x90F8bf…`    | Deployer – has DMV_ROLE + INSURER_ROLE |
| 1     | `0xFFcF8F…`    | First owner                          |
| 2     | `0x6E11BA…`    | New owner after transfer             |
| 3     | `0x9c5cD9…`    | Service centre (SERVICE_ROLE already granted) |

(your prefix may differ—just keep the same index ordering)

#### Step-by-step in the page

| #  | What you do on the page | Value to type / choose | Sender to pick in Active sender |
|----|-------------------------|------------------------|--------------------------------|
| 1  | Select sender           | choose `0x90F8bf…` (index 0) |                                |
| 2  | VIN field               | `TESTVIN-901`          |                                |
| 3  | Payload / IPFS          | `ipfs://reg`           |                                |
| 4  | Owner address           | paste `0xFFcF8F…` (index 1) |                                |
| 5  | Click Register (DMV)    | —                      | still `0x90F8bf…`              |
| 6  | Click Load History → row 0 appears | —                      |                                |
| 7  | Change sender dropdown    | choose `0xFFcF8F…` (index 1) |                                |
| 8  | New owner address       | `0x6E11BA…` (index 2)  |                                |
| 9  | Payload (overwrite)     | `doc#A1`               |                                |
| 10 | Click Transfer Ownership | —                      | sender `0xFFcF8F…`             |
| 11 | Change sender dropdown    | choose `0x9c5cD9…` (index 3) |                                |
| 12 | Payload (overwrite)     | `ipfs://service`       |                                |
| 13 | Click Add Service       | —                      | sender `0x9c5cD9…`             |
| 14 | Change sender dropdown    | back to `0x90F8bf…` (index 0) |                                |
| 15 | Payload                 | `ipfs://accident`      |                                |
| 16 | Click Add Accident      | —                      | sender `0x90F8bf…`             |
| 17 | Change sender dropdown    | choose `0x6E11BA…` (index 2) |                                |
| 18 | Payload                 | `km:123456`            |                                |
| 19 | Click Add Odometer      | —                      | sender `0x6E11BA…`             |
| 20 | Click Load History      | —                      |                                |

You should now see 5 rows:

| #  | Type         | Sender        |
|----|--------------|---------------|
| 0  | Registration | `0x90F8bf…`   |
| 1  | Transfer     | `0xFFcF8F…`   |
| 2  | Service      | `0x9c5cD9…`   |
| 3  | Accident     | `0x90F8bf…`   |
| 4  | Odometer     | `0x6E11BA…`   |

(timestamps and payloads match what you typed.)
```
